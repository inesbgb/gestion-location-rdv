{% extends 'base.html.twig' %}

{% block title %}Modifier le Rendez-Vous{% endblock %}

{% block body %}
<div class="flex justify-center items-center min-h-screen">
    <div class="bg-white shadow-md rounded-lg p-6 w-full max-w-4xl">
        <h1 class="text-2xl font-bold mb-6 text-center">Modifier le Rendez-Vous</h1>

       {{ include('appointment_admin/_form.html.twig') }}
    </div>
</div>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM chargé, initialisation du script');

    const dateRdvInput = document.getElementById('rendez_vous1_date_rdv');
    if (!dateRdvInput) {
        console.error("Le champ de date n'a pas été trouvé");
        return;
    }

    console.log('Initialisation de Flatpickr');
    const dateRdvPickr = flatpickr("#rendez_vous1_date_rdv", {
        dateFormat: "Y-m-d",
        onChange: function(selectedDates, dateStr, instance) {
            console.log('Date sélectionnée:', dateStr);
            updateAvailableHours(dateStr);
        }
    });

    function updateAvailableHours(selectedDate) {
        console.log('Mise à jour des heures disponibles pour la date:', selectedDate);
        const hoursSelect = document.getElementById('rendez_vous1_heure_rdv_hour');
        if (!hoursSelect) {
            console.error("L'élément select des heures n'a pas été trouvé");
            return;
        }
        hoursSelect.innerHTML = '<option>Chargement...</option>';

        console.log('Envoi de la requête AJAX');
        fetch(`/admin/appointment/available-hours/${selectedDate}`)
            .then(response => {
                console.log('Réponse reçue, statut:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Données reçues:', data);
                if (!data.allHours || !data.takenHours) {
                    console.error('Les données reçues ne sont pas dans le format attendu');
                    return;
                }
                const availableHours = data.allHours.filter(hour => !data.takenHours.includes(hour));
                console.log('Heures disponibles:', availableHours);
                hoursSelect.innerHTML = '';
                availableHours.forEach(hour => {
                    const option = document.createElement('option');
                    option.value = hour;
                    option.textContent = hour.toString().padStart(2, '0') + ':00';
                    hoursSelect.appendChild(option);
                });
                console.log('Mise à jour du select terminée');
            })
            .catch(error => console.error('Erreur lors de la requête:', error));
    }

    // Initialiser les heures disponibles au chargement de la page si une date est déjà sélectionnée
    const initialDate = dateRdvPickr.selectedDates[0];
    if (initialDate) {
        console.log('Date initiale trouvée:', initialDate);
        updateAvailableHours(initialDate.toISOString().split('T')[0]);
    } else {
        console.log('Aucune date initiale');
    }
});
</script>
{% endblock %}